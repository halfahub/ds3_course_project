---
title: "Project 2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require(data.table)) {
install.packages("data.table")
}
```

### Loading Data

Download and unpack files 

```{r data, cache = TRUE}
if (!file.exists("./tmp")) {
  dir.create("./tmp")
}

if (!file.exists("./data")) {
  dir.create("./data")
}

download.file(
"https://d396qusza40orc.cloudfront.net/getdata%2Fprojectfiles%2FUCI%20HAR%20Dataset.zip",
destfile = "./tmp/dataset.zip"
)

unzip("./tmp/dataset.zip", exdir = "."
)
```

Observing unpacked directories

```{r}
dir("./UCI HAR Dataset")
dir("./UCI HAR Dataset/test")
dir("./UCI HAR Dataset/train")
```

### 1. Merging the training and the test sets to create one data set.

Observe datasets
```{r}
features <-
  fread(
  "./UCI HAR Dataset/features.txt",
  sep = " ",
  header = FALSE,
  col.names = c("feature_id", "feature"),
  stringsAsFactors = FALSE,
  encoding = "UTF-8"
  )
  dim(features)
  str(features)
  
  activity_labels <-
  fread(
  "./UCI HAR Dataset/activity_labels.txt",
  col.names = c("activity_id", "activity_name"),
  stringsAsFactors = FALSE,
  encoding = "UTF-8"
  )
  dim(activity_labels)
  str(activity_labels)
```

Load and skim Train data
```{r}
x_train <-
  fread("./UCI HAR Dataset/train/X_train.txt", col.names = features$feature)
  dim(x_train)
  str(x_train)
  
  activity_labels <- fread("./UCI HAR Dataset/activity_labels.txt")
  names(activity_labels) <- c("activity_id", "activity_name")
  
  y_train <- fread("./UCI HAR Dataset/train/y_train.txt")
  names(y_train)[1] <- "activity_id"
  dim(y_train)
  str(y_train)
```

Add Activities dimension 
```{r}
y_train$activity_factor <-
  factor(
  y_train$activity_id,
  levels = activity_labels$activity_id,
  labels = activity_labels$activity_name
  )
  str(y_train)
  
  if (dim(x_train)[1] == dim(y_train)[1]) {
  train_data <- cbind(y_train[, 2], x_train)
  dim(train_data)
  }
```

Load and observe Test data
```{r}
x_test <-
  fread("./UCI HAR Dataset/test/X_test.txt", col.names = features$feature)
  dim(x_test)
  str(x_test)
  
  
  y_test <- fread("./UCI HAR Dataset/test/y_test.txt")
  names(y_test)[1] <- "activity_id"
  
  y_test$activity_factor <-
  factor(
  y_test$activity_id,
  levels = activity_labels$activity_id,
  labels = activity_labels$activity_name
  )
  str(y_test)
  
  if (dim(x_test)[1] == dim(y_test)[1]) {
  test_data <- cbind(y_test[, 2], x_test)
  dim(test_data)
  }

```

Merge Training and Test datasets in one
```{r}
if (dim(test_data)[2] == dim(train_data)[2]) {
  all_data <- rbind(train_data, test_data)
  dim(all_data)
  write.table(all_data,"./data/all_data.txt")
}
```

### 2. Extracting only the measurements on the mean and standard deviation for each measurement.

Using the RegExp filter *features* dataset, containing features list

```{r}
mean_sd_cols <- grepl("std|mean", as.character(features$feature))
```

Remember that features was augmented by activity in 1st column, 
so include one mo TRUE value for it in the resulting logical vector

```{r}
mean_sd_cols <- c(TRUE, mean_sd_cols)
mean_sd_data <- all_data[, ..mean_sd_cols]

dim(mean_sd_data)
str(mean_sd_data)

write.table(mean_sd_data,"./data/mean_sd_data.txt")
```

### 3. Setting descriptive activity names to name the activities in the data set.

This requirement is fulfilled on step 1, when Activities column is attached as a factor

```{r}
class(mean_sd_data$activity_factor)
table(mean_sd_data$activity_factor)
str(mean_sd_data$activity_factor)
```

### 4. From the data set in step 2, creating a second, independent tidy data set with the average of each variable for each activity and each subject.

```{r}
averaged_by_activity <- mean_sd_data[,lapply(.SD,mean),by="activity_factor"]
names(averaged_by_activity) <- gsub("sd\\(\\)","SD", names(averaged_by_activity))
names(averaged_by_activity) <- gsub("mean\\(\\)","Mean", names(averaged_by_activity))
names(averaged_by_activity) <- gsub("meanFreq\\(\\)","Mean_Freq", names(averaged_by_activity))
names(averaged_by_activity)[-1] <- paste("Avg", names(averaged_by_activity)[-1], sep = "_")
names(averaged_by_activity)[1] <- "Activity"

str(averaged_by_activity)
write.table(averaged_by_activity,"./data/averaged_by_activity.txt")
```
